<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´í˜ì´ì§€</title>
    <link rel="stylesheet" href="/static/css/mypage/mypage.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="/static/js/mypage/mypage.js" defer></script>
</head>
<body>
    <!-- ğŸ”¹ ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ ë°” -->
    <nav class="navbar">
        <div class="navbar_logo">
            <a href="http://58.127.241.84:61080/main/main.html">
                <img src="/static/images/rootair.jpg"/>
            </a>
        </div>
        <ul class="navbar_menu">
            <li><a href="http://58.127.241.84:61080/main/main.html">ì˜ˆì•½</a></li>
            <li><a href="http://58.127.241.84:61080/notices/notices.html">ê³µì§€ì‚¬í•­</a></li>
            <li><a href="http://58.127.241.84:61080/qna/qna.html">ë¬¸ì˜ì‚¬í•­</a></li>
        </ul>
        <ul class="navbar_member" id="navbar_member">
            <!-- ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ë™ì  ì—…ë°ì´íŠ¸ -->
        </ul>
    </nav>

    <!-- ğŸ”¹ ì‚¬ìš©ì ì •ë³´ -->
    <section class="user-info">
        <h2>ë‚˜ì˜ ì •ë³´</h2>
        <div class="info-box">
            <div class="info-content">
                <div class="profile">
                    <h3 id="username">ì‚¬ìš©ì ì •ë³´ ë¡œë”© ì¤‘...</h3>
                    <p><strong>PHONE</strong> | <span id="phone_number">-</span></p>
                    <p><strong>EMAIL</strong> | <span id="email">-</span></p>
                    <p><strong>ADDRESS</strong> | <span id="address">-</span></p>
                </div>
                <div class="circle-container">
                    <div class="circle deep-blue">
                        <p>ì´ ìì‚°</p>
                        <h2><span id="balance">0</span><span class="unit">ì›</span></h2>
                    </div>
                    <div class="circle right-blue">
                        <p>ì´ ì”ì—¬ ë§ˆì¼ë¦¬ì§€</p>
                        <h2><span id="mileage">0</span></h2>
                    </div>
                    <div class="circle green">
                        <p>ì˜ˆì•½ëœ ì—¬ì •</p>
                        <h2 id="flight_cnt">0</h2>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ğŸ”¹ í•­ê³µê¶Œ ì˜ˆì•½ ì •ë³´ -->
    <section class="ticket-info">
        <h2>í•­ê³µê¶Œ ì˜ˆì•½ ì •ë³´</h2>
        <div id="ticket-container">ë¡œë”© ì¤‘...</div>
        <div class="user-buttons">
            <button id="editProfileBtn" class="edit-btn">íšŒì› ì •ë³´ ìˆ˜ì •</button>
            <button id="deleteAccountBtn" class="delete-btn">íšŒì› íƒˆí‡´</button>
        </div>
    </section>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // âœ… ë§ˆì´í˜ì´ì§€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            fetch("http://58.127.241.84:60119/api/mypage", {
                method: "GET",
                credentials: "include"
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                    window.location.href = "http://58.127.241.84:61080/member/member_login.html";
                    return;
                }

                document.getElementById("username").textContent = data.username || "ì‚¬ìš©ì ì •ë³´ ì—†ìŒ";
                document.getElementById("phone_number").textContent = data.phone_number || "ì—†ìŒ";
                document.getElementById("email").textContent = data.email || "ì—†ìŒ";
                document.getElementById("address").textContent = (data.address || "ì—†ìŒ") + " " + (data.add_detail || "");
                document.getElementById("balance").textContent = data.balance.toLocaleString() || "0";
                document.getElementById("mileage").textContent = data.mileage.toLocaleString() || "0";
                document.getElementById("flight_cnt").textContent = data.flight_cnt || "0";
            })
            .catch(error => console.error("âŒ ë§ˆì´í˜ì´ì§€ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error));

            // âœ… ì˜ˆì•½ëœ í•­ê³µê¶Œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            fetch("http://58.127.241.84:60119/api/mypage/get_tickets", {
                method: "GET",
                credentials: "include"
            })
            .then(response => response.json())
            .then(data => {
                const ticketContainer = document.getElementById("ticket-container");
                ticketContainer.innerHTML = "";

                if (!data || data.length === 0) {
                    ticketContainer.innerHTML = "<p>ì˜ˆì•½ëœ í•­ê³µê¶Œì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                    return;
                }

                data.forEach(ticket => {
                    const ticketItem = document.createElement("div");
                    ticketItem.classList.add("ticket-item");
                    ticketItem.innerHTML = `
                        <p><strong>í•­ê³µí¸:</strong> ${ticket.flight_name}</p>
                        <p><strong>ì¶œë°œ:</strong> ${ticket.departure_airport} (${ticket.departure_time})</p>
                        <p><strong>ë„ì°©:</strong> ${ticket.arrival_airport} (${ticket.arrival_time})</p>
                        <p><strong>ì¢Œì„ ë“±ê¸‰:</strong> ${ticket.seat_class}</p>
                        <p><strong>ê°€ê²©:</strong> ${ticket.price.toLocaleString()}ì›</p>
                    `;
                    ticketContainer.appendChild(ticketItem);
                });
            })
            .catch(error => console.error("âŒ í•­ê³µê¶Œ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error));

            // âœ… íšŒì›ì •ë³´ ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ íšŒì›ì •ë³´ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™
            document.getElementById("editProfileBtn").addEventListener("click", function () {
                fetch("http://58.127.241.84:60119/api/mypage/edit", {
                    method: "GET",
                    credentials: "include"
                })
                .then(response => response.json())
                .then(data => {
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    } else {
                        alert("íšŒì›ì •ë³´ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    }
                })
                .catch(error => console.error("âŒ íšŒì›ì •ë³´ ìˆ˜ì • ì´ë™ ì˜¤ë¥˜:", error));
            });
        });
    </script>
</body>
</html>

